<script>
    async function sendToCallback(response) {
        // Ensure items array is JSON-stringified for URLSearchParams
        const payload = {...response};
        if (payload.items && typeof payload.items !== 'string') {
            payload.items = JSON.stringify(payload.items);
        }

        try {
            const result = await fetch("{% url 'django_athm:athm_callback' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(payload)
            });

            if (!result.ok) {
                console.error('Callback failed:', result.status);
            }
        } catch (error) {
            console.error('Network error:', error);
        }
    }

    async function authorizationATHM(response) {
        await sendToCallback(response);
    }

    async function cancelATHM(response) {
        await sendToCallback(response);
    }

    async function expiredATHM(response) {
        await sendToCallback(response);
    }

    var ATHM_Checkout = {
        env: "{{ env }}",
        publicToken: "{{ publicToken }}",
        timeout: {{ timeout }},
        orderType: "",
        theme: "{{ theme }}",
        lang: "{{ lang|safe }}",
        total: {{ total }},
        metadata1: "{{ metadata1|safe }}",
        metadata2: "{{ metadata2|safe }}",
        items: {{ items }},
        phoneNumber: ""
    }
</script>

<script src="https://payments.athmovil.com/api/js/athmovil_base.js"></script>

<div id="ATHMovil_Checkout_Button_payment"></div>
