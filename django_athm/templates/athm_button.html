<script>
    async function sendToCallback(response) {
        const csrftoken = "{{ csrf_token }}";

        try {
            const result = await fetch("{% url 'django_athm:athm_callback' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: new URLSearchParams(response)
            });

            if (!result.ok) {
                console.error('Callback failed:', result.status);
            }
        } catch (error) {
            console.error('Network error:', error);
        }
    }

    function authorizationATHM(response) {
        sendToCallback(response);
    }

    function cancelATHM(response) {
        sendToCallback(response);
    }

    function expiredATHM(response) {
        sendToCallback(response);
    }

    var ATHM_Checkout = {
        env: "{{ env }}",
        publicToken: "{{ publicToken }}",
        timeout: {{ timeout }},
        theme: "{{ theme }}",
        lang: "{{ lang|safe }}",
        total: {{ total }},
        phoneNumber: {{ phone_number }},
        metadata1: "{{ metadata1|safe }}",
        metadata2: "{{ metadata2|safe }}",
        {% autoescape off %}
            items: {{ items }}
        {% endautoescape %}
    }

    {% if tax %}
        ATHM_Checkout.tax = {{ tax }};
    {% else %}
        ATHM_Checkout.tax = null;
    {% endif %}

    {% if subtotal %}
        ATHM_Checkout.subtotal = {{ subtotal }};
    {% else %}
        ATHM_Checkout.subtotal = null;
    {% endif %}
</script>

<script src="https://payments.athmovil.com/api/js/athmovil_base.js"></script>

<div id="ATHMovil_Checkout_Button_payment"></div>
